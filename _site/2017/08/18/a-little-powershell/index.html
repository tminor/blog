<html>
  <head>
    <meta content='A PowerShell script involving cyclists. - tminor.io' property='og:title' />
    <title>A PowerShell script involving cyclists. - tminor.io</title>
    <link href='http://localhost:4000/images/fav.png' rel='shortcut icon'>
<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css' />
<link href='http://localhost:4000/stylesheets/style.css' rel='stylesheet' type='text/css' />
<link href='http://localhost:4000/stylesheets/syntax.css' rel='stylesheet' type='text/css' />
<link href='http://localhost:4000/stylesheets/responsive.css' rel='stylesheet' type='text/css' />
<!-- - -->
<script src='http://localhost:4000/javascripts/jquery.js' type='text/javascript'></script>
<script src='http://localhost:4000/javascripts/pd.js' type='text/javascript'></script>
<script src='http://localhost:4000/javascripts/basics.js' type='text/javascript'></script>
<!--<script type="text/javascript" src="https://www.google.com/jsapi"></script>-->
<!-- - -->
<meta content='width=device-width, initial-scale=1.0, user-scalable=no' name='viewport'>
<meta content='text/html; charset=utf-8' http-equiv='content-type' />
<meta content="http://localhost:4000/og.png" property="og:image" />
<meta content="" property="fb:app_id" />

  <meta content='http://localhost:4000/2017/08/18/a-little-powershell/' property='og:url' />
  <meta content="A little backgroundI&rsquo;ve been involved in a Fantasy Football league for the past few years, and each year the dr..." property='og:description' />
  <meta content="article" property="og:type" />

<!-- - -->
<!--<script type='text/javascript'>
  //<![CDATA[
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', '']);
    _gaq.push(['_trackPageview']);
    
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  //]]>
</script>-->
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1&appId=";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

  </head>
  <body>
    <header>
<a id="go-back-home" href="http://localhost:4000"><img src="http://localhost:4000/images/shebang.svg" alt="#!" width="53" height="59"></a>
<p>tminor.io</p>
</header>

    <div id='container'>
      <div class="block">
  
    <a target="_top"
       class="main" 
       href="http://localhost:4000/about">
       About
     </a>
  
    <a target="_top"
       class="main" 
       href="http://localhost:4000https://blog.tminor.io">
       Blog
     </a>
  
    <a target="_top"
       class="main" 
       href="http://localhost:4000/feed.xml">
       RSS
     </a>
  
</div>
      <section class="paging">
  
    <div class="left">
      <a href="/2017/07/02/passing-some-web-security-tests/">
        ‹
      </a>
    </div>
  
  
</section>
      <div class="content">
        <section class='post'>
          <h1 class="upcase">
            <div class='date'>18 Aug 2017</div>
            A PowerShell script involving cyclists.
          </h1>
          <h2>A little background</h2>

<p>I&rsquo;ve been involved in a Fantasy Football league for the past few years, and each year the draft order has been decided in some inventive way. This year, an announcement was made that read as such:</p>

<blockquote>
<p>The 2017 Canada Games Road Cycling - Male Criterium. It is truly an event that no one here will have an advantage in understanding. There are 45 bikers and everyone in the League will choose three. The HIGHEST FINISHER of your three will be your <em>official</em> choice. Everyone&rsquo;s official choice will decide the draft order.</p>
</blockquote>

<p>Given that I&rsquo;ve not had access to my homelab recently, I thought this might be a good opportunity to be productive and practice some scripting.</p>

<hr>

<h2>Beggining with a rough idea</h2>

<p>The members of The League were provided with enough resources to locate the race participants; after finding the list I copied the text directly from the source page and stuck it in a text file that ended up looking something like this:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">Alexander Amiri         Cycling
[British Columbia]  Brendan Armstrong   Cycling
[Quebec]  Raphaël Auclair       Cycling
[Ontario]  Tim Austen   Cycling
[Saskatchewan]  Caleb Bender    Cycling
[Manitoba]  Willem Boersma      Cycling
[Prince Edward Island]  André Boudreau  Cycling
[Saskatchewan]  Lukas Conly     Cycling
[New Brunswick]  Alex Cormier   Cycling
[Quebec]  Pier-André Côté       Cycling
. . .
</code></pre></div>
<p>Not being familiar with cycling, my first step was Googling; searching yielded a pretty decent result with <a href="http://www.procyclingstats.com/">Pro Cycling Stats</a>. I tested the site by using some of the names as inputs to the site&rsquo;s search function and found that a direct match for a name yielded that rider&rsquo;s race results in a nicely formatted chart. I initially considered calculating average finishing position for each rider but quickly discarded the idea upon realizing that each race had a decently large variation in its number of participants. Ultimately, I envisioned taking the list as an input and producing as an output a ranked list of the race participants.</p>

<h2>Problem solving</h2>

<p>I needed a way to effeciently determine which riders were better than others. After a bit more exploration, I found that the site features a nifty &ldquo;head-to-head&rdquo; application/script that can compare any number of riders using a variety of statistics. Why devise a way to compare riders when you could just take advantage of something that already exists? It&rsquo;s hard to know exactly what the application does in calculating each rider&rsquo;s score, but I can safely assume that it&rsquo;s more effective than anything I could devise.</p>

<p>After a bit of experimentation, I noticed that the application appears to use PHP&rsquo;s <code>parse_url()</code> (or something similar) to accept values via the URI:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">http://www.procyclingstats.com/rider.php?id=Tim_Ariesen&amp;c=6&amp;ids=170986,126972
</code></pre></div>
<p>I recognized this pattern from my earlier testing; a rider&rsquo;s page uses a URI that conforms to the following scheme:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">http://www.procyclingstats.com/rider.php?id=170986
</code></pre></div>
<p>So I needed a way to collect riders&rsquo; IDs and feed them to the &ldquo;head-to-head&rdquo; application. Thankfully, the search function also uses a very predictable URI scheme:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">http://www.procyclingstats.com/search.php?term=tim+ariesen&amp;searchf=Search
</code></pre></div>
<h2>Taking names</h2>

<p>Using the list of names created earlier, we can generate an input for some kind of function that interacts with the search application. Before we get to that, we need to clean up the list so that each name can be cleanly passed to <code>search.php</code>.</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="c"># File containing the names of race participants</span>
<span class="nv">$File</span> <span class="p">=</span> <span class="s2">&quot;C:\Users\user\Desktop\cycles.txt&quot;</span>

<span class="c"># Get rider names</span>
<span class="nv">$Riders</span> <span class="p">=</span> <span class="p">@()</span>
<span class="nv">$Riders</span> <span class="p">=</span> <span class="nb">Get-Content</span> <span class="n">-Path</span> <span class="nv">$File</span>
<span class="nv">$Riders</span> <span class="p">=</span> <span class="nv">$Riders</span> <span class="o">-replace</span> <span class="s1">&#39;(?=\[).*?(?=\])\]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
<span class="nv">$Riders</span> <span class="p">=</span> <span class="nv">$Riders</span> <span class="o">-replace</span> <span class="s1">&#39;Cycling&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
<span class="nv">$Riders</span> <span class="p">=</span> <span class="nv">$Riders</span><span class="p">.</span><span class="n">trim</span><span class="p">()</span>
<span class="nv">$Riders</span> <span class="p">=</span> <span class="nv">$Riders</span> <span class="o">-replace</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span></code></pre></figure>

<p>We begin by creating a variable for the text file containing the rider names. We then create another variable called <code>$Riders</code> and tell PowerShell that we want it to be an empty array by using an empty array subexpression <code>@()</code>. Generally, PowerShell is very good at guessing data types but sometimes it doesn&rsquo;t get it right!</p>

<p>We then use the <code>Get-Content</code> cmdlet to retrieve text from <code>cycles.txt</code> and store it as the value of <code>$Riders</code>. Next, we apply a series of regular expressions using the <code>-replace</code> operator; the syntax is as follows:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">&quot;operand string&quot; -replace &#39;match pattern&#39;, &#39;replace pattern&#39;
</code></pre></div>
<p>The match pattern uses regular expressions; our first regex replaces anything delimited by an opening and closing square bracket with an empty string; our second regex also replaces anything matching <code>Cycling</code> with an empty string. Next, we use the <code>.Trim()</code> method to rid each line of leading and trailing white space. Lastly, we replace any remaining spaces with a <code>+</code>. After transformation, each line should conform to the following pattern:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">firstname+lastname
</code></pre></div>
<h2>Enter Invoke-WebRequest</h2>

<p>We now have all of the input we need to interact with Pro Cycling Stats&rsquo;s <code>search.php</code>; we can use a handy cmdlet called <code>Invoke-WebRequest</code> to handle the interaction part. Running <code>Get-Help Invoke-WebRequest</code> returns:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">DESCRIPTION
    The Invoke-WebRequest cmdlet sends HTTP, HTTPS, FTP, and FILE requests to a web page or web service. It parses the response and returns collections of forms, links, images, and other significant HTML elements.
</code></pre></div>
<p>Wow, great!</p>

<p>Something important to understand about PowerShell is that it is <a href="https://powertoe.wordpress.com/2014/04/26/you-know-powershell-is-an-object-oriented-language-right/">object-oriented</a>. With that in mind, we can assume that if we execute <code>Invoke-WebRequest</code> as a subexpression, we can access its properties somehow. PowerShell uses <code>.</code> as a property dereferencing operator; let&rsquo;s use <code>Invoke-WebRequest</code> to examine this behavior:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nb">Invoke-WebRequest</span> <span class="n">-Uri</span> <span class="n">google</span><span class="p">.</span><span class="n">com</span> <span class="p">|</span> <span class="nb">Format-List</span></code></pre></figure>

<p>The outpute should look something like:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">StatusCode        : 200
StatusDescription : OK
Content           : &lt;!doctype html&gt;&lt;html itemscope=&quot;&quot; itemtype=&quot;http://schema.org/WebPage&quot; lang=&quot;en&quot;&gt;&lt;head&gt;&lt;meta content=&quot;Search the world&#39;s information, including webpages, images, videos and more. Google has many speci...
RawContent        : HTTP/1.1 200 OK
                    X-XSS-Protection: 1; mode=block
                    X-Frame-Options: SAMEORIGIN
                    Vary: Accept-Encoding
                    Transfer-Encoding: chunked
                    Accept-Ranges: none
                    Cache-Control: private, max-age=0
                    Content-Type: ...
Forms             : {f}
. . .
</code></pre></div>
<p>We can see that one of the properties is <code>Links:</code>, so we can look more closely by running:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nb">Invoke-WebRequest</span> <span class="n">-Uri</span> <span class="n">google</span><span class="p">.</span><span class="n">com</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">Links</span> <span class="p">|</span> <span class="nb">Format-List</span></code></pre></figure>

<p>The output should be several lines of attribute-value pairs. Another cool thing about PowerShell (and maybe this is a cool thing about <code>Invoke-WebRequest</code> specifically) is that you can access the values of these attributes in the same way you&rsquo;d do it with an object (using subexpressions and the <code>.</code> operator mentioned earlier):</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="p">(</span><span class="nb">Invoke-WebRequest</span> <span class="n">-Uri</span> <span class="n">google</span><span class="p">.</span><span class="n">com</span><span class="p">).</span><span class="n">Links</span><span class="p">.</span><span class="n">outerHTML</span></code></pre></figure>

<h2>Collecting IDs</h2>

<p>Using the strategy outlined above, we might be able to devise some way to corral links to each rider&rsquo;s page. If we can do this, we can probably extract their ID as well.</p>

<p>Let&rsquo;s go back to accessing the properties of our web request; with some knowledge of HTML, we can deduce that if we collect <code>href=</code> values, we can probably find the links that contain our desired ID numbers. Let&rsquo;s take a look at some example output by running the following:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="p">(</span><span class="nb">Invoke-WebRequest</span> <span class="n">-Uri</span> <span class="s2">&quot;http://www.procyclingstats.com/search.php?term=tim+ariesen&amp;searchf=Search&quot;</span><span class="p">).</span><span class="n">Links</span><span class="p">.</span><span class="n">Href</span></code></pre></figure>

<p>And the output:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">info.php?action=1502217039
index.php?cookie=1&amp;amp;SetCookieConsent=1
http://www.procyclingstats.com/
https://www.facebook.com/ProCyclingStats
https://www.youtube.com/channel/UCpu35hcS3_1IlEb80aJem7Q
https://twitter.com/ProCyclingStats
http://www.procyclingstats.com/contact.php
. . .
?goto=rider&amp;amp;id=170986&amp;amp;rnk=0&amp;amp;type=1&amp;amp;title=search_page&amp;amp;term=tim ariesen
race.php?id=171047
race.php?id=171088
race.php?id=171127
race.php?id=170996
race.php?id=171007
race.php?id=171015
. . .
</code></pre></div>
<p>We can see that our output contains quite a few references to ID numbers that identify specific races and other non-rider entities. How do we determine which IDs belong to the riders we initially passed to <code>search.php</code>? First, let&rsquo;s corral the links we need.</p>

<p>Using our prepared rider names, we can iterate over them using a <code>foreach</code> loop to execute some commands. So for each <code>$Rider</code>, we want all <code>href=</code> attributes and their corresponding values from the <code>Links:</code> property of each web request. That would look something like:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="k">foreach</span> <span class="p">(</span><span class="nv">$Rider</span> <span class="k">in</span> <span class="nv">$Riders</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">$(</span><span class="nb">Invoke-WebRequest</span> <span class="n">-Uri</span> <span class="p">(</span><span class="s2">&quot;http://www.procyclingstats.com/search.php?term=$Rider&amp;searchf=Search&quot;</span><span class="p">)).</span><span class="n">Links</span><span class="p">.</span><span class="n">Href</span> <span class="p">|</span> <span class="p">`</span>
    <span class="nb">Out-File</span> <span class="n">-FilePath</span> <span class="s2">&quot;C:\Users\user\Desktop\results.txt&quot;</span> <span class="n">-Append</span>
<span class="p">}</span></code></pre></figure>

<p>Notice that we&rsquo;ve used the <code>$Rider</code> variable to pass our rider names to <code>search.php</code> and then piped it out to a file, appending each line along the way. This leaves us with a giant file containing every possible link for every rider fed to <code>search.php</code>. Now we can begin to identify a salient characteristic that can be used to isolate each desired URI. With a little intuition, we can deduce that the lines we probably want contain a specific pattern: <code>rnk=0</code>. How do we find and store the lines we want?</p>

<p>Let&rsquo;s try starting with a variable and again tell PowerShell that we&rsquo;d like it to be an empty array.</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$Results</span> <span class="p">=</span> <span class="p">@()</span></code></pre></figure>

<p>Using the previously generated <code>results.txt</code> file, we can get its content and select lines by matching against a regular expression:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$Results</span> <span class="p">=</span> <span class="nb">Get-Content</span> <span class="n">-Path</span> <span class="n">C</span><span class="err">:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">user</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="n">results</span><span class="p">.</span><span class="n">txt</span> <span class="p">|</span> <span class="nb">Select-String</span> <span class="n">-Pattern</span> <span class="s1">&#39;.*(\brnk=0\b).*&#39;</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-ExpandProperty</span> <span class="n">line</span></code></pre></figure>

<p>Next, we need to whittle down our results so that we are left with the value of each <code>id=</code> attribute; once again, we do this by using regular expressions. This time, however, we use a regular expression object!</p>

<p>We do this by creating a variable as we normally would but tell PowerShell that this particular object is a regular expression by type casting it as such:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="no">[regex]</span><span class="nv">$regex</span> <span class="p">=</span> <span class="s1">&#39;id=[0-9]*&#39;</span></code></pre></figure>

<p>We can now take advantage of this object&rsquo;s <code>.Match()</code> method:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$Results</span> <span class="p">=</span> <span class="nv">$regex</span><span class="p">.</span><span class="n">Matches</span><span class="p">(</span><span class="nv">$Results</span><span class="p">)</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span><span class="nv">$_</span><span class="p">.</span><span class="n">Value</span><span class="p">}</span></code></pre></figure>

<p>We mustn&rsquo;t forget that our matches are also objects, so we pipe each match to <code>ForEach-Object</code> and use an <a href="https://docs.microsoft.com/en-us/powershell/module/Microsoft.PowerShell.Core/about_Automatic_Variables?view=powershell-5.1">automatic variable</a>; in our case, we use <code>$_</code> to capture each matches <code>.Value</code> property:</p>

<blockquote>
<p>[$_] contains the current object in the pipeline object. You can use this variable in commands that perform an action on every object or on selected objects in a pipeline.</p>
</blockquote>

<p>Now we can begin to isolate only the ID numbers and concatenate them to create a single string:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$Results</span> <span class="p">=</span> <span class="nv">$Results</span> <span class="o">-replace</span> <span class="s1">&#39;id=&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
<span class="nv">$IDString</span> <span class="p">=</span> <span class="nv">$Results</span> <span class="n">-join</span> <span class="s1">&#39;,&#39;</span></code></pre></figure>

<p>The first line should look familiar; the second uses the <code>-join</code> operator to perform concatenation, using a <code>,</code> as a delimiter for each ID number.</p>

<h2>Create your own object</h2>

<p>With our newly created ID string, we can now interact with <code>rider.php</code>&lsquo;s &ldquo;head-to-head&rdquo; function.</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$WebRequest</span> <span class="p">=</span> <span class="nb">Invoke-WebRequest</span> <span class="n">-Uri</span> <span class="s2">&quot;http://www.procyclingstats.com/rider.php?id=Tim_Ariesen&amp;c=6&amp;ids=$IDString&quot;</span></code></pre></figure>

<p>We also need to create another empty array:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$RiderObjects</span> <span class="p">=</span> <span class="p">@()</span></code></pre></figure>

<p>We&rsquo;ll cover that in a little bit.</p>

<p>With that out of the way, we can begin to concoct a way to handle the content retrieved by <code>$WebRequest</code>. By examining the source of the &ldquo;head-to-head&rdquo; page, we notice that each rider&rsquo;s name and respective score are contained within a <code>&lt;div&gt;</code> HTML element. Based on our experience so far, we know that we can probably capture the values we want using regular expressions. So here&rsquo;s the regular expression we&rsquo;ll use:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">&lt;div style=&quot;font: bold 20px tahoma, arial, Century Gothic; letter-spacing: -1px; &quot;&gt;([a-zA-z]*)&lt;br \/&gt;([a-zA-z]*)&lt;\/div&gt;&lt;div style=&quot;font: bold 18px tahoma, arial, Century Gothic; letter-spacing: -1px; padding: 9px 0; color: #e00; &quot;&gt;([0-9]*\.[0-9]*%)&lt;\/div&gt;
</code></pre></div>
<p>With the above regular expression, we use three capture groups: first name, last name, and score. We can use these values as properties in a custom object. Here&rsquo;s how we&rsquo;d do that:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$regex</span><span class="p">.</span><span class="n">Matches</span><span class="p">(</span><span class="nv">$WebRequest</span><span class="p">.</span><span class="n">Content</span><span class="p">)</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span><span class="p">{</span>
    <span class="nv">$objRider</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">psobject</span> <span class="n">-Property</span> <span class="p">@{</span>
        <span class="n">Name</span>  <span class="p">=</span> <span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="n">1</span><span class="p">].</span><span class="n">Value</span><span class="p">)</span><span class="s2"> </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="n">2</span><span class="p">].</span><span class="n">value</span><span class="p">)</span><span class="s2">&quot;</span>
        <span class="n">Score</span> <span class="p">=</span> <span class="p">(</span><span class="no">[decimal]</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="n">3</span><span class="p">].</span><span class="n">Value</span><span class="p">).</span><span class="n">Replace</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="nv">$Global:RiderObjects</span> <span class="p">+=</span> <span class="nv">$objRider</span>
<span class="p">}</span></code></pre></figure>

<p>First, we start with our <code>$regex</code> object and use the <code>.Matches()</code> method using <code>$WebRequest</code>&rsquo;s <code>Content</code> property (which happens to be raw HTML) as input. Next, we pipe the output to a <code>ForEach-Object</code> loop that creates a new object called <code>$objRider</code> for each match. Again, we use the <code>$_</code> automatic variable and the <code>.</code> property dereference operator to access each capture group. The &ldquo;Name&rdquo; property is straightforward; we take capture groups <code>1</code> and <code>2</code> and concatenate them into one string. For the &ldquo;Score&rdquo; property, we need to perform some manipulation so that we can properly sort them numerically (otherwise, PowerShell would assume that the percentage number is a string and sort it alphabetically). We do this by type casting the value for &ldquo;Score&rdquo; as <code>[decimal]</code>, call the <code>.Replace()</code> method, replacing <code>%</code> with an empty string, all within a subexpression that returns the resultant value as a float (or decimal).</p>

<p>Once we&rsquo;ve successfully created our object, we use the assignment by addition operator <code>+=</code> to append the object to an empty array, <code>$Global:RiderObjects</code>. We tell PowerShell that this variable should be accessible in the global scope so that we can use it outside the scope of the <code>ForEach-Object</code> loop.</p>

<p>With our newly created objects, we can now manipulate the results as we would any other object.</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$RiderObjects</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Score</span> <span class="n">-Descending</span></code></pre></figure>

<p>Output:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">Name              Score
----              -----
Joseph Didden      13.0
Tim Ariesen         6.8
Nicolas Zukowsky    5.2
Kurt Penno          2.1
Jordann Jones       1.2
Willem Boersma      0.9
</code></pre></div>
<hr>

<h2>Final thoughts</h2>

<p>One thing I didn&rsquo;t control for was false positives; the person who scored the highest, for example, only participated in one race that took place in 1939. Another example is that Tim Ariesen isn&rsquo;t participating in the race we care about. I have some ideas as to how I might account for such aberrations, but it was a fun exercise nevertheless. As an outro, here&rsquo;s the script in aggregate:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="c"># File containing the names of race participants</span>
<span class="nv">$File</span> <span class="p">=</span> <span class="s2">&quot;C:\Users\tminor\Desktop\cycles.txt&quot;</span>

<span class="c"># Get rider names</span>
<span class="nv">$Riders</span> <span class="p">=</span> <span class="p">@()</span>
<span class="nv">$Riders</span> <span class="p">=</span> <span class="nb">Get-Content</span> <span class="n">-Path</span> <span class="nv">$File</span>
<span class="nv">$Riders</span> <span class="p">=</span> <span class="nv">$Riders</span> <span class="o">-replace</span> <span class="s1">&#39;(?=\[).*?(?=\])\]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
<span class="nv">$Riders</span> <span class="p">=</span> <span class="nv">$Riders</span> <span class="o">-replace</span> <span class="s1">&#39;Cycling&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
<span class="nv">$Riders</span> <span class="p">=</span> <span class="nv">$Riders</span><span class="p">.</span><span class="n">trim</span><span class="p">()</span>
<span class="nv">$Riders</span> <span class="p">=</span> <span class="nv">$Riders</span> <span class="o">-replace</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span>

<span class="c"># After some manipulation, use rider names to search www.procyclingstats.com</span>
<span class="c"># Store all output in a file</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$Rider</span> <span class="k">in</span> <span class="nv">$Riders</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">$(</span><span class="nb">Invoke-WebRequest</span> <span class="n">-Uri</span> <span class="p">(</span><span class="s2">&quot;http://www.procyclingstats.com/search.php?term=$Rider&amp;searchf=Search&quot;</span><span class="p">)).</span><span class="n">Links</span><span class="p">.</span><span class="n">Href</span> <span class="p">|</span> <span class="p">`</span>
    <span class="nb">Out-File</span> <span class="n">-FilePath</span> <span class="s2">&quot;C:\Users\tminor\Desktop\results.txt&quot;</span> <span class="n">-Append</span>
<span class="p">}</span>

<span class="c"># Read the file generated above and store all matching lines in an array</span>
<span class="nv">$Results</span> <span class="p">=</span> <span class="p">@()</span>
<span class="nv">$Results</span> <span class="p">=</span> <span class="nb">Get-Content</span> <span class="n">-Path</span> <span class="n">C</span><span class="err">:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">tminor</span><span class="p">\</span><span class="n">Desktop</span><span class="p">\</span><span class="n">results</span><span class="p">.</span><span class="n">txt</span> <span class="p">|</span> <span class="nb">Select-String</span> <span class="n">-Pattern</span> <span class="s1">&#39;.*(\brnk=0\b).*&#39;</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-ExpandProperty</span> <span class="n">line</span>

<span class="c"># Determine rider IDs by extracting them from URIs with an ID regex</span>
<span class="no">[regex]</span><span class="nv">$Regex</span> <span class="p">=</span> <span class="s1">&#39;id=[0-9]*&#39;</span>
<span class="nv">$Results</span> <span class="p">=</span> <span class="nv">$regex</span><span class="p">.</span><span class="n">Matches</span><span class="p">(</span><span class="nv">$Results</span><span class="p">)</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span><span class="nv">$_</span><span class="p">.</span><span class="n">Value</span><span class="p">}</span>

<span class="c"># Store only the ID number</span>
<span class="nv">$Results</span> <span class="p">=</span> <span class="nv">$Results</span> <span class="o">-replace</span> <span class="s1">&#39;id=&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>

<span class="c"># Concat all ID numbers to use in URI to compare riders</span>
<span class="nv">$IDString</span> <span class="p">=</span> <span class="nv">$Results</span> <span class="n">-join</span> <span class="s1">&#39;,&#39;</span>
<span class="nv">$WebRequest</span> <span class="p">=</span> <span class="nb">Invoke-WebRequest</span> <span class="n">-Uri</span> <span class="s2">&quot;http://www.procyclingstats.com/rider.php?id=Chris MacLeod&amp;c=6&amp;ids=$IDString&quot;</span>

<span class="c"># Initialize new array for custom object</span>
<span class="nv">$RiderObjects</span> <span class="p">=</span> <span class="p">@()</span>

<span class="c"># Use regex to capture all relevant data</span>
<span class="no">[regex]</span><span class="nv">$Regex</span> <span class="p">=</span> <span class="s1">&#39;&lt;div style=&quot;font: bold 20px tahoma, arial, Century Gothic; letter-spacing: -1px; &quot;&gt;([a-zA-z]*)&lt;br \/&gt;([a-zA-z]*)&lt;\/div&gt;&lt;div style=&quot;font: bold 18px tahoma, arial, Century Gothic; letter-spacing: -1px; padding: 9px 0; color: #e00; &quot;&gt;([0-9]*\.[0-9]*%)&lt;\/div&gt;&#39;</span>

<span class="c"># Iterate over regex matches, creating a custom object </span>
<span class="c"># For each match, add each capture group to its respective object attribute</span>
<span class="nv">$Regex</span><span class="p">.</span><span class="n">Matches</span><span class="p">(</span><span class="nv">$WebRequest</span><span class="p">.</span><span class="n">Content</span><span class="p">)</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span><span class="p">{</span>
    <span class="nv">$ObjRider</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">psobject</span> <span class="n">-Property</span> <span class="p">@{</span>
        <span class="n">Name</span>  <span class="p">=</span> <span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="n">1</span><span class="p">].</span><span class="n">Value</span><span class="p">)</span><span class="s2"> </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="n">2</span><span class="p">].</span><span class="n">value</span><span class="p">)</span><span class="s2">&quot;</span>
        <span class="n">Score</span> <span class="p">=</span> <span class="p">(</span><span class="no">[decimal]</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="n">3</span><span class="p">].</span><span class="n">Value</span><span class="p">).</span><span class="n">Replace</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="nv">$Global:RiderObjects</span> <span class="p">+=</span> <span class="nv">$ObjRider</span>
<span class="p">}</span>

<span class="c"># Sort the custom object by score in descending order</span>
<span class="nv">$RiderObjects</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Score</span> <span class="n">-Descending</span></code></pre></figure>

<p><strong>UPDATE:</strong> My final draft position is second from last. I experienced a glimmer of hope when the time trials performed by the same group of riders yielded a first place finish for me, but alas, the taste of victory is bitter-sweet.</p>

          <!--
<br />
<p>
  Until next time,<br/>
  Thomas
  <span class="muted">at 21:09</span>
</p>
<p>
  <img src="/images/blog.svg" alt="./blog.sh" width="70" height="40" /> 
</p>
-->


        </section>
      </div>
      

      
        <div class="block">
  <div id="disqus_thread"></div>
    <script>
      /**
      *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
      *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
      */
      /*
      var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
      };
      */
      (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//blog-tminor-io.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      })();
    </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

      
      <div class="block">
  
    <a target="_top"
       class="main" 
       href="http://localhost:4000/about">
       About
     </a>
  
    <a target="_top"
       class="main" 
       href="http://localhost:4000https://blog.tminor.io">
       Blog
     </a>
  
    <a target="_top"
       class="main" 
       href="http://localhost:4000/feed.xml">
       RSS
     </a>
  
</div>
    </div>
    <!--
<footer>
  <a href="http://github.com/muan/scribble" class="muted">built with Jekyll using Scribble theme</a>
  <br />
  <br />
  <img src="http://localhost:4000/images/eof.svg" alt="./blog.sh" width="40" height="27"/> 
</footer>
-->

  </body>
</html>
